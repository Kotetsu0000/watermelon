# スイカゲーム Web アプリ版 開発 Copilot 指示書

## 1. プロジェクト概要

本プロジェクトは、人気パズルゲーム「スイカゲーム」の Web アプリケーション版を、クライアントサイド技術（JavaScript, HTML, CSS）のみで完全に再現することを目的とします。サーバーサイド処理は行わず、ユーザーの Web ブラウザ上で完結するスタンドアロンアプリケーションとして設計し、最終的に GitHub Pages での公開を目指します。

**技術スタック:**

-   **HTML:** ゲーム構造、Canvas 要素定義
-   **CSS:** レイアウト、スタイリング、レスポンシブデザイン
-   **JavaScript:** ゲームロジック、物理エンジン制御、描画処理、イベントハンドリング、状態管理
-   **物理エンジン:** Matter.js (推奨) または Planck.js

## 2. 開発方針と進め方

-   **段階的開発:** コア機能（フルーツ落下、結合、スコア）から実装し、徐々に UI、サウンド、高度な物理挙動を追加します。
-   **物理エンジンの早期導入と調整:** Matter.js を導入し、仕様書 3.2 節のパラメータを参考に、フルーツの基本的な挙動（落下、衝突、転がり）を早期に確認・調整してください。特に「予測困難性」や「手触り」を再現するためのパラメータチューニングが重要です。
-   **アセット管理:** フルーツ画像やサウンドファイルは、パスを指定して読み込めるように実装してください。初期段階ではプレースホルダーを使用しても構いません。
-   **モジュール化:** 機能ごとに JavaScript ファイルを分割し、可読性と保守性を高めることを推奨します。（例: `game.js`, `physics.js`, `ui.js`, `fruit.js`など）
-   **バージョン管理:** Git を使用し、こまめにコミットしてください。

## 3. Copilot への具体的な指示

### 3.1. HTML 構造 (index.html)

-   基本的な HTML 構造を生成してください。
-   ゲーム描画用の `<canvas>` 要素を配置してください。
-   スコア表示、次のフルーツ予告、ゲームオーバー表示などの UI 要素を配置するためのコンテナ要素を準備してください（これらは CSS でスタイリングし、JS で内容を更新します）。
-   必要な JavaScript ファイル（メインロジック、物理エンジンライブラリ）を読み込む `<script>` タグを含めてください。

### 3.2. CSS (style.css)

-   基本的なページスタイリング（背景色、フォントなど）を行ってください。
-   ゲーム画面（Canvas）を中央に配置し、レスポンシブに対応するようスタイリングしてください (仕様書 4.1)。アスペクト比を維持したスケーリングを意識してください。
-   スコア表示、次のフルーツ予告、ゲーム開始/ゲームオーバー画面の UI 要素の基本的なスタイリングを行ってください (仕様書 4.3, 4.4, 4.5)。

### 3.3. JavaScript (初期セットアップ)

-   ゲームのメインループ (`requestAnimationFrame` を使用) の雛形を作成してください (仕様書 7.2)。
-   Canvas のコンテキストを取得し、基本的な描画設定を行ってください。
-   Matter.js エンジンの初期化コードを生成してください（ワールド作成、レンダラー設定など）。仕様書 3.1、3.2 を参考に、重力 (`engine.world.gravity.y`) などを設定してください。
-   ゲームの境界（箱）となる静的な壁を Matter.js で作成してください。

### 3.4. フルーツの実装 (例: `fruit.js` またはメインロジック内)

-   仕様書 2.1 の「フルーツ進化テーブル」に基づき、フルーツの種類、進化順序、獲得スコア、相対サイズ（物理ボディの半径）、画像パスなどを管理するデータ構造（例: オブジェクトの配列やクラス）を定義してください。
    ```javascript
    // 例
    const fruitData = [
        {
            name: 'さくらんぼ',
            evolutionTo: 'いちご',
            score: 1,
            radius: 20,
            image: 'path/to/sakuranbo.png',
            id: 0 /* ... */,
        },
        // ... 他のフルーツ
    ];
    ```
-   指定された種類のフルーツを Matter.js のボディとして生成する関数を作成してください。この際、仕様書 3.2 および 4.2 のフルーツごとの物理プロパティ（質量、摩擦、反発係数、サイズ）を設定できるようにしてください。
    -   「小さいフルーツの方が相対的に重い」という特性（仕様書 3.2）を再現できるよう、質量や密度を調整するロジックを考慮してください。

### 3.5. ゲームロジック (例: `game.js`)

-   **フルーツ落下:**
    -   プレイヤーがマウス/タッチでフルーツを落下させる操作を実装してください (仕様書 2.2, 7.3)。
        -   マウスの X 座標に応じて、次に落下するフルーツのプレビュー位置を更新してください。
        -   クリック/タップでフルーツを落下させてください。落下開始位置は固定 (仕様書 2.2)。
    -   次に落下するフルーツをランダムに選択するロジックを実装してください（さくらんぼ、いちご、ぶどう、デコポン、かきが各 20%の確率。仕様書 2.3）。
-   **フルーツ結合:**
    -   Matter.js の衝突イベント (`Matter.Events.on(engine, 'collisionStart', callback)`) を使用して、フルーツ同士の衝突を検知してください。
    -   同じ種類のフルーツが衝突した場合、それらを削除し、進化後の新しいフルーツを生成するロジックを実装してください (仕様書 2.2)。
        -   新しいフルーツは、元の 2 つのフルーツの接触位置の中央に生成してください。
        -   結合時にスコアを加算してください (仕様書 2.4)。
        -   スイカ同士が結合した場合は消滅し、66 点を加算する特別処理を実装してください (仕様書 2.2)。
    -   結合時の「弾け飛び」や「転がり」を自然に見せるため、新しいフルーツに適切な初期速度/角速度を与えることを検討してください。
-   **スコアリング:**
    -   現在のスコアを管理する変数を持ち、フルーツ結合時に更新してください。
    -   ハイスコアを localStorage に保存・読み込みする機能を実装してください (仕様書 2.4)。
-   **ゲームオーバー判定:**
    -   フルーツが箱の上部ラインを一定時間（例: 3 秒）超え続けた場合にゲームオーバーとするロジックを実装してください (仕様書 2.5)。
        -   Matter.js のボディがラインを越えたことを検知し、タイマーを開始/リセットする処理が必要です。
    -   落下させたフルーツが箱の内部に入らなかった場合もゲームオーバーとしてください (仕様書 2.5)。
-   **状態管理:**
    -   ゲームの状態（開始前、プレイ中、一時停止、ゲームオーバー）を管理する仕組みを実装してください (仕様書 6)。
    -   状態に応じて、入力処理、物理シミュレーションの更新、描画内容を制御してください。
    -   一時停止機能（物理演算停止、入力無効化）を実装してください。

### 3.6. UI/UX (例: `ui.js` またはメインロジック内)

-   **描画:**
    -   Canvas に Matter.js のボディ（フルーツ）を画像として描画するロジックを実装してください。フルーツの画像と物理ボディのサイズ・位置を同期させてください。
    -   ダブルバッファリングを検討し、描画のちらつきを抑えてください (仕様書 7.2)。
-   **情報表示:**
    -   現在のスコアとハイスコアを画面に表示し、リアルタイムで更新してください (仕様書 4.3)。
    -   次に落下するフルーツの画像を画面上部に予告表示してください (仕様書 4.3)。
-   **画面遷移:**
    -   ゲーム開始画面（スタートボタン）を実装してください (仕様書 4.4)。
    -   ゲームオーバー画面（最終スコア、リトライボタン）を実装してください (仕様書 4.5)。

### 3.7. サウンド (例: `audio.js` またはメインロジック内)

-   BGM のループ再生、ゲーム状態に応じた切り替え機能を実装してください (仕様書 5.1)。Web Audio API または `<audio>` 要素を使用してください。
-   フルーツ落下音、衝突音、結合/進化音、ゲームオーバー音などの効果音を適切なタイミングで再生する機能を実装してください (仕様書 5.2)。
-   連続結合時の演出（サウンド含む）も考慮してください。

### 3.8. パフォーマンスと最適化

-   `requestAnimationFrame` を使用したメインループを実装してください (仕様書 7.2)。
-   `clearRect` の使い方を最適化することを検討してください (仕様書 7.2)。
-   不要になった Matter.js のボディは適切にワールドから削除 (`Matter.World.remove`) してください。

### 3.9. デプロイ

-   すべてのファイルパスが GitHub Pages 環境で正しく解決されるよう、相対パスを使用してください (仕様書 7.4)。

## 4. テスト

-   各機能実装後、手動で動作確認を行ってください。
-   特に物理挙動（フルーツの転がり方、結合時の動き、ポップコーン現象のバランス）は、仕様書で言及されている「面白さ」を再現できるよう、繰り返しテストとパラメータ調整を行ってください。
-   異なるブラウザや画面サイズでの基本的な表示・動作確認を行ってください。

この指示書を参考に、段階的に機能を実装し、不明な点や複雑なロジックについては、具体的なコード生成やアルゴリズムの提案を Copilot に求めてください。
